<?xml version="1.0" encoding="UTF-8"?>
<atlassian-plugin key="com.teknolojikpanda.bitbucket.ai-code-reviewer" name="${project.name}" plugins-version="2">
    <plugin-info>
        <description>${project.description}</description>
        <version>${project.version}</version>
        <vendor name="${project.organization.name}" url="${project.organization.url}"/>
        <param name="plugin-icon">images/pluginIcon.png</param>
        <param name="plugin-logo">images/pluginLogo.png</param>
        <param name="atlassian-data-center-status">compatible</param>
        <param name="atlassian-data-center-compatible">true</param>
    </plugin-info>

    <!-- Active Objects Entity Definitions -->
    <ao key="ao-module">
        <description>Active Objects module for AI Code Reviewer</description>
        <entity>com.teknolojikpanda.bitbucket.aireviewer.ao.AIReviewConfiguration</entity>
        <entity>com.teknolojikpanda.bitbucket.aireviewer.ao.AIReviewHistory</entity>
        <entity>com.teknolojikpanda.bitbucket.aireviewer.ao.AIReviewChunk</entity>
        <entity>com.teknolojikpanda.bitbucket.aireviewer.ao.AIReviewRepoConfiguration</entity>
    </ao>

    <!--
        Component imports for dependency injection
        These are required for @ComponentImport to work properly
    -->
    <component-import key="userManager" interface="com.atlassian.sal.api.user.UserManager"/>
    <component-import key="loginUriProvider" interface="com.atlassian.sal.api.auth.LoginUriProvider"/>
    <component-import key="templateRenderer" interface="com.atlassian.templaterenderer.TemplateRenderer"/>
    <component-import key="activeObjects" interface="com.atlassian.activeobjects.external.ActiveObjects"/>
    <component-import key="pluginAccessor" interface="com.atlassian.plugin.PluginAccessor"/>
    <component-import key="eventPublisher" interface="com.atlassian.event.api.EventPublisher"/>
    <component-import key="pullRequestService" interface="com.atlassian.bitbucket.pull.PullRequestService"/>
    <component-import key="commentService" interface="com.atlassian.bitbucket.comment.CommentService"/>
    <component-import key="repositoryService" interface="com.atlassian.bitbucket.repository.RepositoryService"/>
    <component-import key="compareService" interface="com.atlassian.bitbucket.compare.CompareService"/>
    <component-import key="applicationPropertiesService" interface="com.atlassian.bitbucket.server.ApplicationPropertiesService"/>
    <component-import key="permissionService" interface="com.atlassian.bitbucket.permission.PermissionService"/>
    <component-import key="userService" interface="com.atlassian.bitbucket.user.UserService"/>
    <component-import key="securityService" interface="com.atlassian.bitbucket.user.SecurityService"/>
    <component-import key="repositoryHookService" interface="com.atlassian.bitbucket.hook.repository.RepositoryHookService"/>


    <!--
        Component scanning is enabled via atlassian-spring-scanner-maven-plugin
        All @Component, @Named, and @Scanned classes will be automatically discovered
    -->

    <!-- Explicit component declarations for services -->
    <component key="aiReviewerConfigService" 
               class="com.teknolojikpanda.bitbucket.aireviewer.service.AIReviewerConfigServiceImpl" 
               public="true">
        <description>AI Reviewer Configuration Service</description>
        <interface>com.teknolojikpanda.bitbucket.aireviewer.service.AIReviewerConfigService</interface>
    </component>

    <component key="aiReviewService" 
               class="com.teknolojikpanda.bitbucket.aireviewer.service.AIReviewServiceImpl" 
               public="true">
        <description>AI Review Service</description>
        <interface>com.teknolojikpanda.bitbucket.aireviewer.service.AIReviewService</interface>
    </component>

    <component key="pullRequestAIReviewListener" 
               class="com.teknolojikpanda.bitbucket.aireviewer.listener.PullRequestAIReviewListener">
        <description>Pull Request AI Review Event Listener</description>
    </component>

    <component key="aiDiffProvider"
               class="com.teknolojikpanda.bitbucket.aicode.core.DefaultDiffProvider">
        <description>Diff provider for AI review pipeline</description>
        <interface>com.teknolojikpanda.bitbucket.aicode.api.DiffProvider</interface>
    </component>

    <component key="aiChunkPlanner"
               class="com.teknolojikpanda.bitbucket.aicode.core.HeuristicChunkPlanner">
        <description>Chunk planner for AI review pipeline</description>
        <interface>com.teknolojikpanda.bitbucket.aicode.api.ChunkPlanner</interface>
    </component>

    <component key="sizeFirstChunkStrategy"
               class="com.teknolojikpanda.bitbucket.aicode.core.SizeFirstChunkStrategy">
        <description>Default size-based chunk strategy</description>
        <interface>com.teknolojikpanda.bitbucket.aicode.api.ChunkStrategy</interface>
    </component>

    <component key="aiReviewClient"
               class="com.teknolojikpanda.bitbucket.aicode.core.OllamaAiReviewClient">
        <description>Ollama-backed AI review client</description>
        <interface>com.teknolojikpanda.bitbucket.aicode.api.AiReviewClient</interface>
    </component>

    <component key="aiReviewOrchestrator"
               class="com.teknolojikpanda.bitbucket.aicode.core.TwoPassReviewOrchestrator">
        <description>Two-pass AI review orchestrator</description>
        <interface>com.teknolojikpanda.bitbucket.aicode.api.ReviewOrchestrator</interface>
    </component>

    <component key="aiReviewConfigFactory"
               class="com.teknolojikpanda.bitbucket.aicode.core.ReviewConfigFactory">
        <description>Factory for building review configuration snapshots</description>
    </component>

    <component key="reviewHistoryService"
               class="com.teknolojikpanda.bitbucket.aireviewer.service.ReviewHistoryService">
        <description>Provides access to stored AI review history</description>
    </component>

    <component key="progressRegistry"
               class="com.teknolojikpanda.bitbucket.aireviewer.progress.ProgressRegistry">
        <description>Tracks live AI review progress state for polling endpoints</description>
    </component>

    <repository-merge-check key="ai-reviewer-in-progress-merge-check"
                            name="AI Review In-Progress Merge Check"
                            class="com.teknolojikpanda.bitbucket.aireviewer.hook.AIReviewInProgressMergeCheck">
        <description>Prevents pull requests from being merged while the AI review is still running.</description>
    </repository-merge-check>

    <!-- REST API for Configuration -->
    <rest key="aiReviewerRestEndpoints"
          path="/ai-reviewer"
          version="1.0">
        <description>REST API for AI Code Reviewer configuration</description>
        <package>com.teknolojikpanda.bitbucket.aireviewer.rest</package>
    </rest>

    <!-- Admin Configuration Navigation -->
    <web-section key="ai-reviewer-admin-section"
                 name="AI Code Reviewer"
                 location="atl.admin.menu"
                 weight="100">
        <description>AI Code Reviewer administration links</description>
        <label>AI Code Reviewer</label>
    </web-section>

    <!-- Admin Configuration Page -->
    <web-item key="ai-reviewer-admin-link"
              name="AI Code Reviewer"
              section="atl.admin.menu/ai-reviewer-admin-section"
              weight="10">
        <description>Link to AI Code Reviewer Configuration</description>
        <label key="ai.reviewer.admin.link"/>
        <link>/plugins/servlet/ai-reviewer/admin</link>
        <conditions>
            <condition class="com.atlassian.bitbucket.web.conditions.HasGlobalPermissionCondition">
                <permission>ADMIN</permission>
            </condition>
        </conditions>
    </web-item>

    <web-item key="ai-reviewer-history-link"
              name="AI Review History"
              section="atl.admin.menu/ai-reviewer-admin-section"
              weight="20">
        <description>Link to AI Code Reviewer history</description>
        <label key="ai.reviewer.history.link"/>
        <link>/plugins/servlet/ai-reviewer/history</link>
        <conditions>
            <condition class="com.atlassian.bitbucket.web.conditions.HasGlobalPermissionCondition">
                <permission>ADMIN</permission>
            </condition>
        </conditions>
    </web-item>

    <!-- Admin Configuration Servlet -->
    <servlet key="ai-reviewer-admin-servlet"
             name="AI Reviewer Admin Servlet"
             class="com.teknolojikpanda.bitbucket.aireviewer.servlet.AdminConfigServlet">
        <description>Admin configuration page for AI Code Reviewer</description>
        <url-pattern>/ai-reviewer/admin</url-pattern>
    </servlet>

    <servlet key="ai-reviewer-history-servlet"
             name="AI Reviewer History Servlet"
             class="com.teknolojikpanda.bitbucket.aireviewer.servlet.ReviewHistoryServlet">
        <description>Admin history page for AI Code Reviewer</description>
        <url-pattern>/ai-reviewer/history</url-pattern>
    </servlet>

    <!-- Web Resources -->
    <web-resource key="ai-reviewer-admin-resources" name="AI Reviewer Admin Resources">
        <description>Resources for the admin configuration page</description>
        <dependency>com.atlassian.auiplugin:ajs</dependency>
        <dependency>com.atlassian.auiplugin:aui-flag</dependency>
        <dependency>com.atlassian.auiplugin:aui-form-validation</dependency>
        <dependency>com.atlassian.auiplugin:aui-spinner</dependency>
        <dependency>com.atlassian.auiplugin:aui-select2</dependency>

        <resource type="download" name="ai-reviewer-admin.css" location="/css/ai-reviewer-admin.css"/>
        <resource type="download" name="ai-reviewer-progress.css" location="/css/ai-reviewer-progress.css"/>
        <resource type="download" name="ai-reviewer-common.js" location="/js/ai-reviewer-common.js"/>
        <resource type="download" name="ai-reviewer-scope-tree.js" location="/js/ai-reviewer-scope-tree.js"/>
        <resource type="download" name="ai-reviewer-admin.js" location="/js/ai-reviewer-admin.js"/>
        <context>ai-reviewer-admin</context>
    </web-resource>

    <web-resource key="ai-reviewer-history-resources" name="AI Reviewer History Resources">
        <description>Resources for the AI review history page</description>
        <dependency>com.atlassian.auiplugin:ajs</dependency>
        <dependency>com.atlassian.auiplugin:aui-spinner</dependency>
        <resource type="download" name="ai-reviewer-admin.css" location="/css/ai-reviewer-admin.css"/>
        <resource type="download" name="ai-reviewer-progress.css" location="/css/ai-reviewer-progress.css"/>
        <resource type="download" name="ai-reviewer-common.js" location="/js/ai-reviewer-common.js"/>
        <resource type="download" name="ai-reviewer-progress.js" location="/js/ai-reviewer-progress.js"/>
        <resource type="download" name="ai-reviewer-history.js" location="/js/ai-reviewer-history.js"/>
        <context>ai-reviewer-history</context>
    </web-resource>

    <web-resource key="ai-reviewer-pr-progress-resources" name="AI Reviewer PR Progress Resources">
        <description>Resources for the pull request progress panel</description>
        <dependency>com.atlassian.auiplugin:ajs</dependency>
        <resource type="download" name="ai-reviewer-progress.css" location="/css/ai-reviewer-progress.css"/>
        <resource type="download" name="ai-reviewer-common.js" location="/js/ai-reviewer-common.js"/>
        <resource type="download" name="ai-reviewer-progress.js" location="/js/ai-reviewer-progress.js"/>
        <resource type="download" name="ai-reviewer-pr-progress.js" location="/js/ai-reviewer-pr-progress.js"/>
        <context>atl.general</context>
    </web-resource>

    <!-- PR progress resources are injected via global context and the script renders the panel dynamically -->
</atlassian-plugin>
