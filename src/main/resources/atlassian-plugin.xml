<?xml version="1.0" encoding="UTF-8"?>
<atlassian-plugin key="com.example.bitbucket.ai-code-reviewer" name="${project.name}" plugins-version="2">
    <plugin-info>
        <description>${project.description}</description>
        <version>${project.version}</version>
        <vendor name="${project.organization.name}" url="${project.organization.url}"/>
        <param name="plugin-icon">images/pluginIcon.png</param>
        <param name="plugin-logo">images/pluginLogo.png</param>
        <param name="atlassian-data-center-status">compatible</param>
        <param name="atlassian-data-center-compatible">true</param>
    </plugin-info>

    <!-- Internationalization Resources -->
    <resource type="i18n" name="i18n" location="i18n/ai-code-reviewer"/>

    <!-- Active Objects Entity Definitions -->
    <ao key="ai-reviewer-ao"
        name="AI Reviewer Active Objects">
        <description>Stores AI reviewer configuration, execution history, and per-chunk telemetry.</description>
        <entity>com.example.bitbucket.aireviewer.ao.AIReviewConfiguration</entity>
        <entity>com.example.bitbucket.aireviewer.ao.AIReviewHistory</entity>
        <entity>com.example.bitbucket.aireviewer.ao.AIReviewChunk</entity>
        <entity>com.example.bitbucket.aireviewer.ao.AIReviewRepoConfiguration</entity>
    </ao>

    <!--
        Component imports for dependency injection
        These are required for @ComponentImport to work properly
    -->
    <component-import key="userManager" interface="com.atlassian.sal.api.user.UserManager"/>
    <component-import key="loginUriProvider" interface="com.atlassian.sal.api.auth.LoginUriProvider"/>
    <component-import key="templateRenderer" interface="com.atlassian.templaterenderer.TemplateRenderer"/>
    <component-import key="activeObjects" interface="com.atlassian.activeobjects.external.ActiveObjects"/>
    <component-import key="pluginAccessor" interface="com.atlassian.plugin.PluginAccessor"/>
    <component-import key="eventPublisher" interface="com.atlassian.event.api.EventPublisher"/>
    <component-import key="pullRequestService" interface="com.atlassian.bitbucket.pull.PullRequestService"/>
    <component-import key="commentService" interface="com.atlassian.bitbucket.comment.CommentService"/>
    <component-import key="repositoryService" interface="com.atlassian.bitbucket.repository.RepositoryService"/>
    <component-import key="compareService" interface="com.atlassian.bitbucket.compare.CompareService"/>
    <component-import key="applicationPropertiesService" interface="com.atlassian.bitbucket.server.ApplicationPropertiesService"/>
    <component-import key="permissionService" interface="com.atlassian.bitbucket.permission.PermissionService"/>
    <component-import key="userService" interface="com.atlassian.bitbucket.user.UserService"/>


    <!--
        Component scanning is enabled via atlassian-spring-scanner-maven-plugin
        All @Component, @Named, and @Scanned classes will be automatically discovered
    -->

    <!-- Explicit component declarations for services -->
    <component key="aiReviewerConfigService"
               name="AI Reviewer Configuration Service"
               class="com.example.bitbucket.aireviewer.service.AIReviewerConfigServiceImpl"
               public="true">
        <description>Manages global settings and scoped overrides for the AI reviewer.</description>
        <interface>com.example.bitbucket.aireviewer.service.AIReviewerConfigService</interface>
    </component>

    <component key="aiReviewService"
               name="AI Review Execution Service"
               class="com.example.bitbucket.aireviewer.service.AIReviewServiceImpl"
               public="true">
        <description>Runs the AI review workflow, posting findings and updating history.</description>
        <interface>com.example.bitbucket.aireviewer.service.AIReviewService</interface>
    </component>

    <component key="pullRequestAIReviewListener"
               name="AI Review Pull Request Listener"
               class="com.example.bitbucket.aireviewer.listener.PullRequestAIReviewListener">
        <description>Listens for pull request events and triggers initial or update AI reviews.</description>
    </component>

    <component key="aiDiffProvider"
               name="AI Reviewer Diff Provider"
               class="com.example.bitbucket.aicode.core.DefaultDiffProvider">
        <description>Streams pull request diffs and records per-file stats for downstream analysis.</description>
        <interface>com.example.bitbucket.aicode.api.DiffProvider</interface>
    </component>

    <component key="aiChunkPlanner"
               name="AI Reviewer Chunk Planner"
               class="com.example.bitbucket.aicode.core.HeuristicChunkPlanner">
        <description>Plans chunk boundaries for AI processing using heuristic scoring.</description>
        <interface>com.example.bitbucket.aicode.api.ChunkPlanner</interface>
    </component>

    <component key="sizeFirstChunkStrategy"
               name="Size-First Chunk Strategy"
               class="com.example.bitbucket.aicode.core.SizeFirstChunkStrategy">
        <description>Implements a size-prioritized chunk strategy used by the heuristic planner.</description>
        <interface>com.example.bitbucket.aicode.api.ChunkStrategy</interface>
    </component>

    <component key="aiReviewClient"
               name="Ollama AI Review Client"
               class="com.example.bitbucket.aicode.core.OllamaAiReviewClient">
        <description>Handles prompt execution against Ollama with retry, timeout, and telemetry hooks.</description>
        <interface>com.example.bitbucket.aicode.api.AiReviewClient</interface>
    </component>

    <component key="aiReviewOrchestrator"
               name="Two-Pass Review Orchestrator"
               class="com.example.bitbucket.aicode.core.TwoPassReviewOrchestrator">
        <description>Coordinates the two-pass review pipeline: overview planning followed by detailed analysis.</description>
        <interface>com.example.bitbucket.aicode.api.ReviewOrchestrator</interface>
    </component>

    <component key="aiReviewConfigFactory"
               name="Review Configuration Factory"
               class="com.example.bitbucket.aicode.core.ReviewConfigFactory">
        <description>Constructs immutable review configuration objects consumed by the review pipeline.</description>
    </component>

    <component key="reviewHistoryService"
               name="AI Review History Service"
               class="com.example.bitbucket.aireviewer.service.ReviewHistoryService">
        <description>Provides read APIs for AI review history entries, chunk telemetry, and summaries.</description>
    </component>

    <!-- REST API for Configuration -->
    <rest key="aiReviewerRestEndpoints"
          name="AI Reviewer REST Resources"
          path="/ai-reviewer"
          version="1.0">
        <description>Exposes configuration, repository scope, override management, and manual review trigger endpoints.</description>
        <package>com.example.bitbucket.aireviewer.rest</package>
    </rest>

    <!-- Admin Configuration Page -->
    <web-item key="ai-reviewer-admin-link"
              name="AI Code Reviewer"
              section="atl.admin/admin-plugins-section"
              weight="200">
        <description>Navigates administrators to the AI reviewer configuration screen.</description>
        <label key="ai.reviewer.admin.link"/>
        <link>/plugins/servlet/ai-reviewer/admin</link>
    </web-item>

    <web-item key="ai-reviewer-history-link"
              name="AI Review History"
              section="atl.admin/admin-plugins-section"
              weight="201">
        <description>Opens the AI review history dashboard for auditing prior runs.</description>
        <label key="ai.reviewer.history.link"/>
        <link>/plugins/servlet/ai-reviewer/history</link>
    </web-item>

    <!-- Admin Configuration Servlet -->
    <servlet key="ai-reviewer-admin-servlet"
             name="AI Reviewer Admin Servlet"
             class="com.example.bitbucket.aireviewer.servlet.AdminConfigServlet">
        <description>Serves the AI reviewer admin interface rendered via Velocity templates.</description>
        <url-pattern>/ai-reviewer/admin</url-pattern>
    </servlet>

    <servlet key="ai-reviewer-history-servlet"
             name="AI Reviewer History Servlet"
             class="com.example.bitbucket.aireviewer.servlet.ReviewHistoryServlet">
        <description>Provides the AI review history UI and supporting data endpoints.</description>
        <url-pattern>/ai-reviewer/history</url-pattern>
    </servlet>

    <!-- Web Resources -->
    <web-resource key="ai-reviewer-admin-resources" name="AI Reviewer Admin Resources">
        <description>Bundles styles and scripts used by the AI reviewer admin configuration page.</description>
        <dependency>com.atlassian.auiplugin:ajs</dependency>
        <dependency>com.atlassian.auiplugin:aui-flag</dependency>
        <dependency>com.atlassian.auiplugin:aui-form-validation</dependency>
        <dependency>com.atlassian.auiplugin:aui-spinner</dependency>

        <resource type="download" name="ai-reviewer-admin.css" location="/css/ai-reviewer-admin.css"/>
        <resource type="download" name="ai-reviewer-admin.js" location="/js/ai-reviewer-admin.js"/>
        <context>ai-reviewer-admin</context>
    </web-resource>

    <web-resource key="ai-reviewer-history-resources" name="AI Reviewer History Resources">
        <description>Provides UI resources for the AI review history dashboard.</description>
        <dependency>com.atlassian.auiplugin:ajs</dependency>
        <dependency>com.atlassian.auiplugin:aui-spinner</dependency>
        <resource type="download" name="ai-reviewer-admin.css" location="/css/ai-reviewer-admin.css"/>
        <resource type="download" name="ai-reviewer-history.js" location="/js/ai-reviewer-history.js"/>
        <context>ai-reviewer-history</context>
    </web-resource>

</atlassian-plugin>
