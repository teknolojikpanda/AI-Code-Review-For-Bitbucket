<!DOCTYPE html>
<html>
<head>
    <title>AI Code Reviewer - Health</title>
    <meta name="decorator" content="atl.admin">
    <meta name="application-base-url" content="$baseUrl">
    $webResourceManager.requireResource("com.teknolojikpanda.bitbucket.ai-code-reviewer:ai-reviewer-health-resources")
</head>
<body>
<header class="aui-page-header" style="padding-bottom: 20px;">
    <div class="aui-page-header-inner">
        <div class="aui-page-header-main">
            <h1>AI Code Reviewer Health</h1>
        </div>
        <div class="aui-page-header-actions">
            <a class="aui-button" href="$baseUrl/plugins/servlet/ai-reviewer/admin">Back to Configuration</a>
            <a class="aui-button" href="$baseUrl/plugins/servlet/ai-reviewer/history">History</a>
        </div>
    </div>
</header>

<div class="aui-page-panel">
    <div class="aui-page-panel-inner">
        <section class="aui-page-panel-content">
            <div id="ai-reviewer-health-container">
                <div class="health-toolbar">
                    <button type="button" class="aui-button" id="refresh-health-btn">
                        <span class="aui-icon aui-icon-small aui-iconfont-refresh"></span> Refresh
                    </button>
                    <span class="health-toolbar-note">Telemetry refreshes on demand.</span>
                </div>

                <div id="health-message" class="aui-message info" style="display:none;"></div>

                <section class="health-section">
                    <header class="health-header">
                        <h2>Runtime Snapshot</h2>
                        <span id="health-updated" class="health-updated">—</span>
                    </header>
                    <div class="health-grid">
                        <div class="health-card">
                            <span class="health-label">Queue</span>
                            <span class="health-value" id="health-queue-active">—</span>
                            <span class="health-subtext" id="health-queue-note">—</span>
                        </div>
                        <div class="health-card">
                            <span class="health-label">Worker Pool</span>
                            <span class="health-value" id="health-worker-active">—</span>
                            <span class="health-subtext" id="health-worker-note">—</span>
                        </div>
                        <div class="health-card">
                            <span class="health-label">Rate Limits</span>
                            <span class="health-value" id="health-rate-limit">—</span>
                            <span class="health-subtext" id="health-rate-note">—</span>
                        </div>
                        <div class="health-card">
                            <span class="health-label">Retention</span>
                            <span class="health-value" id="health-retention-total">—</span>
                            <span class="health-subtext" id="health-retention-note">—</span>
                        </div>
                    </div>
                </section>

                <section class="queue-section" style="margin-top: 24px;">
                    <header class="queue-header">
                        <h2>Review Queue</h2>
                        <span id="queue-updated" class="queue-updated">—</span>
                    </header>
                    <div class="queue-grid">
                        <div class="queue-card">
                            <span class="queue-label">Active</span>
                            <span class="queue-value" id="queue-active">—</span>
                        </div>
                        <div class="queue-card">
                            <span class="queue-label">Available Slots</span>
                            <span class="queue-value" id="queue-available">—</span>
                        </div>
                        <div class="queue-card">
                            <span class="queue-label">Waiting</span>
                            <span class="queue-value" id="queue-waiting">—</span>
                        </div>
                        <div class="queue-card">
                            <span class="queue-label">Max Concurrent</span>
                            <span class="queue-value" id="queue-max-concurrent">—</span>
                        </div>
                        <div class="queue-card">
                            <span class="queue-label">Max Queued</span>
                            <span class="queue-value" id="queue-max-queued">—</span>
                        </div>
                    </div>
                    <div class="queue-note" id="queue-note">—</div>
                    <div class="aui-message info queue-admin-message" id="queue-admin-message" style="display:none;"></div>
                    <div class="queue-columns">
                        <div class="queue-panel">
                            <header>
                                <h3>Queued Reviews</h3>
                                <span class="queue-panel-count" id="queue-entries-count"></span>
                            </header>
                            <div class="queue-empty" id="queue-entries-empty">Loading queued reviews…</div>
                            <table class="aui aui-table aui-table-rowhover" id="queue-entries-table" style="display:none;">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Repository / PR</th>
                                    <th>Requested By</th>
                                    <th>Waiting</th>
                                    <th>Scope Pressure</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="queue-panel">
                            <header>
                                <h3>Recent Queue Actions</h3>
                                <span class="queue-panel-count" id="queue-actions-count"></span>
                            </header>
                            <div class="queue-empty" id="queue-actions-empty">Loading audit log…</div>
                            <table class="aui aui-table aui-table-rowhover" id="queue-actions-table" style="display:none;">
                                <thead>
                                <tr>
                                    <th>When</th>
                                    <th>Action</th>
                                    <th>Actor</th>
                                    <th>Target</th>
                                    <th>Note</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="automation-section" style="margin-top: 24px;">
                    <header class="queue-header">
                        <h2>Rollout Controls</h2>
                        <span id="rollout-updated" class="queue-updated">—</span>
                    </header>
                    <div class="rollout-panel">
                        <div class="rollout-state">
                            <div class="rollout-mode" id="rollout-mode">—</div>
                            <div class="rollout-meta" id="rollout-meta">Scheduler state loading…</div>
                        </div>
                        <div class="rollout-actions">
                            <label for="rollout-reason" class="rollout-label">Reason (optional)</label>
                            <input type="text" id="rollout-reason" class="text medium-field" placeholder="e.g., Maintenance window"/>
                            <div class="rollout-buttons">
                                <button type="button" class="aui-button rollout-btn" data-mode="active">Resume</button>
                                <button type="button" class="aui-button rollout-btn" data-mode="pause">Pause</button>
                                <button type="button" class="aui-button rollout-btn" data-mode="drain">Drain</button>
                            </div>
                        </div>
                    </div>
                    <div class="aui-message" id="rollout-message" style="display:none;"></div>
                </section>

                <section class="automation-section" style="margin-top: 24px;">
                    <header class="queue-header">
                        <h2>Alert Channels</h2>
                        <span id="channels-count" class="queue-updated">—</span>
                    </header>
                    <div class="queue-panel">
                        <div class="aui-message" id="channel-message" style="display:none;"></div>
                        <div class="queue-empty" id="channels-empty">No alert channels configured.</div>
                        <table class="aui aui-table aui-table-rowhover" id="channels-table" style="display:none;">
                            <thead>
                            <tr>
                                <th>Description</th>
                                <th>URL</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <form id="channel-create-form" class="channels-form">
                        <h3>Add Channel</h3>
                        <div class="field-group">
                            <label for="channel-url">Webhook URL *</label>
                            <input type="url" id="channel-url" class="text long-field" placeholder="https://hooks.example.com/guardrails" required/>
                        </div>
                        <div class="field-group">
                            <label for="channel-description">Description</label>
                            <input type="text" id="channel-description" class="text medium-field" placeholder="Ops Pager"/>
                        </div>
                        <div class="field-group checkbox">
                            <input type="checkbox" class="checkbox" id="channel-enabled" checked="checked"/>
                            <label for="channel-enabled">Enabled</label>
                        </div>
                        <div class="field-group checkbox">
                            <input type="checkbox" class="checkbox" id="channel-signing" checked="checked"/>
                            <label for="channel-signing">Sign requests (HMAC-SHA256)</label>
                            <div class="description">If enabled, every alert includes `X-Guardrails-Signature` + timestamp headers computed with the secret below.</div>
                        </div>
                        <div class="field-group">
                            <label for="channel-secret">Signing secret</label>
                            <input type="text" id="channel-secret" class="text medium-field" placeholder="Leave blank to auto-generate"/>
                            <div class="description">Share this secret with the receiving system so it can validate signatures.</div>
                        </div>
                        <div class="field-group">
                            <label for="channel-max-retries">Retry attempts</label>
                            <input type="number" id="channel-max-retries" class="text short-field" min="0" max="5" value="2"/>
                            <label for="channel-backoff" style="margin-left:20px;">Backoff (seconds)</label>
                            <input type="number" id="channel-backoff" class="text short-field" min="1" max="60" value="5"/>
                            <div class="description">Failed deliveries retry with exponential backoff.</div>
                        </div>
                        <div class="field-group">
                            <button type="submit" class="aui-button aui-button-primary">Add Channel</button>
                        </div>
                    </form>
                </section>

                <section class="automation-section" style="margin-top: 24px;">
                    <header class="queue-header">
                        <h2>Alert Delivery History</h2>
                        <span id="deliveries-count" class="queue-updated">—</span>
                    </header>
                    <div class="queue-panel">
                        <div class="aui-message" id="deliveries-message" style="display:none;"></div>
                        <div class="queue-empty" id="deliveries-empty">No deliveries logged yet.</div>
                        <table class="aui aui-table aui-table-rowhover" id="deliveries-table" style="display:none;">
                            <thead>
                            <tr>
                                <th>When</th>
                                <th>Channel</th>
                                <th>Status</th>
                                <th>HTTP</th>
                                <th>Error</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section class="queue-section" style="margin-top: 24px;">
                    <header class="queue-header">
                        <h2>Retention Cleanup</h2>
                        <span id="cleanup-updated" class="queue-updated">—</span>
                    </header>
                    <div class="health-grid">
                        <div class="health-card">
                            <span class="health-label">Last Run</span>
                            <span class="health-value" id="cleanup-last-run">—</span>
                            <span class="health-subtext" id="cleanup-last-run-note">—</span>
                        </div>
                        <div class="health-card">
                            <span class="health-label">Last Outcome</span>
                            <span class="health-value" id="cleanup-last-outcome">—</span>
                            <span class="health-subtext" id="cleanup-last-outcome-note">—</span>
                        </div>
                    </div>
                    <form class="aui" id="cleanup-form">
                        <div class="field-group">
                            <label for="cleanup-enabled">Automatic Cleanup</label>
                            <div class="field-value">
                                <input class="checkbox" type="checkbox" id="cleanup-enabled">
                                <label for="cleanup-enabled">Enable scheduled cleanup of entries older than the retention window.</label>
                                <div class="description">When disabled you can still trigger manual runs with the button below.</div>
                            </div>
                        </div>
                        <div class="field-group">
                            <label for="cleanup-retention-days">Retention window (days)</label>
                            <input class="text" type="number" id="cleanup-retention-days" min="1">
                            <div class="description">History older than this window will be removed.</div>
                        </div>
                        <div class="field-group">
                            <label for="cleanup-batch-size">Batch size</label>
                            <input class="text" type="number" id="cleanup-batch-size" min="1">
                            <div class="description">Maximum entries deleted per job execution.</div>
                        </div>
                        <div class="field-group">
                            <label for="cleanup-interval-minutes">Interval (minutes)</label>
                            <input class="text" type="number" id="cleanup-interval-minutes" min="5">
                            <div class="description">How frequently the automatic job runs per node.</div>
                        </div>
                        <div class="field-group">
                            <div class="buttons">
                                <button type="submit" class="aui-button aui-button-primary" id="cleanup-save-btn">Save Schedule</button>
                                <button type="button" class="aui-button" id="cleanup-run-btn">Run Once</button>
                            </div>
                            <div class="description">Manual runs respect the current settings above but ignore the schedule.</div>
                        </div>
                        <div class="aui-message info" id="cleanup-message" style="display:none;"></div>
                    </form>
                    <div class="queue-panel" style="margin-top: 16px;">
                        <header>
                            <h3>Recent Cleanup Runs</h3>
                            <span class="queue-panel-count" id="cleanup-log-count"></span>
                        </header>
                        <div class="queue-empty" id="cleanup-log-empty">No cleanup runs recorded yet.</div>
                        <table class="aui aui-table aui-table-rowhover" id="cleanup-log-table" style="display:none;">
                            <thead>
                            <tr>
                                <th>When</th>
                                <th>Duration</th>
                                <th>Deleted</th>
                                <th>Actor</th>
                                <th>Status</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section class="queue-section" style="margin-top: 24px;">
                    <header class="queue-header">
                        <h2>Guardrails Alerts</h2>
                        <span id="alerts-updated" class="queue-updated">—</span>
                    </header>
                    <div class="queue-panel">
                        <div class="queue-empty" id="alerts-empty">No active alerts.</div>
                        <table class="aui aui-table aui-table-rowhover" id="alerts-table" style="display:none;">
                            <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Summary</th>
                                <th>Details</th>
                                <th>Recommendation</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="queue-note" id="alerts-note">Alerts refresh when telemetry loads.</div>
                    </div>
                </section>
            </div>
        </section>
    </div>
</div>
</body>
</html>
