name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build and release'
        required: false

jobs:
  build-and-publish:
    name: Build and Publish Release Artifact
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag
        id: vars
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check out tag
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.tag != ''
        run: git checkout "${{ steps.vars.outputs.tag }}"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Build release artifact
        run: mvn -B -ntp clean verify

      - name: Upload plugin JAR to release
        uses: softprops/action-gh-release@v1
        with:
          files: target/ai-code-reviewer-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
